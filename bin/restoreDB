#!/usr/bin/env node

/**
 * Restore a database from a tar.gz file given as argument
 */

"use strict";

var testCommon = require("../test/backend/testCommon"),
	fs = require("fs"),
	path = require("path"),
	targz = require("tar.gz");

if( !process.argv[2] || process.argv[2] === "help") {
	console.log("Restore the database from a tar.gz file");
	console.log("usage : ");
	console.log("    restoreDB [filePath]");
	console.log("");
	console.log("example : from the root dir of the project");
	console.log("    bin/restoreDB test/testDB.tar.gz");
	process.exit(0);
}

var filePath = process.argv[2];
if( filePath[0] !== "/" ) {
	// the path is relative
	filePath = path.join(process.cwd(), filePath);
}

if( !fs.existsSync(filePath)) {
	console.log("Can't find the file : ",filePath);
	process.exit(1);
}

new targz().extract( filePath, process.cwd(), function(err) {
	if(err) {
		console.log("err", err);
		process.exit(1);
	} else {
		testCommon.mongoRestore( filePath )
			.then( function() {
				console.log("database restored");
			})
			.catch( function(err) {
				console.log(err);
				process.exit(1);
			});
	}
});