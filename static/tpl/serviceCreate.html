<template is="auto-binding" id="formTpl">
	
	<form name="form" id="form-add-service" autocomplete="off" onsubmit="checkServiceForm(); return false;">
		<!--<input type="hidden" name="_id" value="{{beneficiary._id.toString()}}">-->
		{%raw%}
		<input type="hidden" name="_id" value="{{service._id}}">
		<input type="hidden" name="category" value="{{service.category}}">
		{%endraw%}
		<div class="row h2">
			<div class="col">
				<label for="inputRef">{{"Type of service" | i18n}}</label>
				{% raw %}
				<select id="inputRef" name="ref" disabled?="{{ service._id }}" required>
					<template if="{{ !service._id }}">
						<option ></option>
					</template>
					<template repeat="{{ serviceRef in refServices}}">
						<option value="{{ serviceRef.ref }}" 
						        checked?="{{ serviceRef.ref === service.ref }}">
							{{ serviceRef.label[lang] }}
						</option>
					</template>
				</select>
				{% endraw %}
			</div>
		</div>
		
		<div class="row h2">
			<div class="col">
				<label for="inputLabel">{{"Label of the service" | i18n}}</label>
				<input type="text" value="{%raw%}{{ service.label }}{%endraw%}" name="label" id="inputLabel">
			</div>
		</div>
		
		<div class="row h2">
			<div class="col">
				<label for="inputProvider">{{"Provider" | i18n}}</label>
				<select id="inputProvider" name="provider">
					{% raw %}
					<template if="{{ !service._id }}">
						<option ></option>
					</template>
					<template repeat="{{ provider in providers}}">
						<option value="{{ provider._id }}" 
						        checked?="{{ provider._id === service.provider}}">
							{{provider.name.family}} {{provider.name.given}} ( {{ jobs[provider.job][lang] }} )
						</option>
					</template>
					{% endraw %}
				</select>
			</div>
		</div>
		<div class="row" style="align-items: initial;">
			<label>{{"Detail of the service" | i18n}}</label>
			<textarea rows="5" cols="60" wrap="hard" name="detail">{%raw%}{{service.detail}}{%endraw%}</textarea>
		</div>
		
		<div class="row h2">
			<label>{{"Start date" | i18n}}</label>
			{%raw%}
			<template if="{{ service._id }}">
				<span id="startDate"><b>{{service.startDate}}</b></span>
			</template>
			<template if="{{ !service._id }}">
				<zdk-input-date name="startDate" id="startDate" staticpos="true"
			                value="{{service.startDate}}" required></zdk-input-date>
			</template>
			{%endraw%}
			<template if="{%raw%}{{ service.frequency !== 'punctual' }}{%endraw%}">
				<label style="padding-left:5px">{{"End date" | i18n}}</label>
				<zdk-input-date name="endDate" id="endDate" staticpos="true"
				                value="{%raw%}{{service.endDate}}{%endraw%}" required></zdk-input-date>
			</template>
		</div>
		
		<div class="row h2" id="frequency">
			<label>{{"Frequency" | i18n}} ({%raw%}{{ service.frequency }}{%endraw%})</label>
			<input type="radio" name="frequency" 
			       value="monthly"
			       onclick = "frequencyChange(event)"
			       {%raw%}checked?="{{ service.frequency == 'monthly' }}"{%endraw%}> {{"Monthly" | i18n}}
			<input type="radio" name="frequency" 
			       value="weekly"
			       onclick = "frequencyChange(event)"
			       {%raw%}checked?="{{ service.frequency == 'weekly' }}"{%endraw%}> {{"Weekly" | i18n}}
			<input type="radio" name="frequency" 
			       value="daily"
			       onclick = "frequencyChange(event)"
			       {%raw%}checked?="{{ service.frequency == 'daily' }}"{%endraw%}> {{"Daily" | i18n}}
			<input type="radio" name="frequency" 
			       value="punctual" 
			       onclick = "frequencyChange(event)"
			       {%raw%}checked?="{{ service.frequency == 'punctual' }}"{%endraw%}> {{"Punctual" | i18n}}
		</div>
		
		<div id="special-inputs">
			<div class="row h2">
				<template if="{%raw%}{{ service.frequency == 'daily' }}{%endraw%}">
					<div id="repeat-group" class="col">
						<label for="input-repeat" style="width:auto">{{"Every" | i18n}}</label>
						<input type="number" id="input-repeat" name="repeat" 
						       value="{%raw%}{{ service.repeat}}{%endraw%}" 
						       style="width: 50px;margin:0px 5px" required min="1" step="1" >&nbsp;
						<span id="repeat-label">{% raw %}{{ service.frequency }}{% endraw %}</span>
					</div>
				</template>
				
				<div class="col" style="align-items: center;">
					<label for="inputDuration" style="width:auto">{{"Duration" | i18n}}</label>
					<select id="inputDuration" name="duration" style="min-width: 100px;margin: 0px 5px;" required>
						{% raw %}
						<template repeat="{{ duration in durations }}">
							<option value="{{duration.value}}" 
							        selected?="{{ service.duration == duration.value }}">{{duration.label}}</option>
						</template>
						{% endraw %}
					</select>
					<label style="width:auto">{{"hour(s)" | i18n}}</label>
				</div>
				
				<template if="{%raw%}{{ service.frequency == 'weekly' }}{%endraw%}">
					<button id="btn-cal-week" class="blue calendar-button" type="button" onclick="onBtnCalWeekClick()">
						<core-icon icon="today"></core-icon>
					</button>
				</template>
				
				<template if="{%raw%}{{ service.frequency == 'monthly' }}{%endraw%}">
					<button id="btn-cal-month" class="blue calendar-button" type="button" onclick="onBtnCalMonthClick()">
						<core-icon icon="today"></core-icon>
					</button>
				</template>
			</div>
		
			<template if="{%raw%}{{ service.frequency !== 'weekly' }}{%endraw%}">
				<div class="row h2">
					<label for="inputStartTime">{{"Start at" | i18n}}</label>
					<select id="inputStartTime" name="time" required>
						{% raw %}
						<template repeat="{{ hour in hours }}">
							<option value="{{hour}}" selected?="{{ service.time == hour }}">{{hour}}</option>
						</template>
						{% endraw %}
					</select>
				</div>
			</template>
			
			<template if="{%raw%}{{ service.frequency == 'monthly' }}{%endraw%}">
				<div id="days-month">
					<template repeat="{%raw%}{{ day in service.when }}{%endraw%}">
						<li class="day">{% raw %}{{day}}{% endraw %} {{" of the month" | i18n}}</li>
					</template>
				</div>
			</template>
			
			<template if="{%raw%}{{ service.frequency == 'weekly' }}{%endraw%}">
				<div id="days-week">
					<template repeat="{%raw%}{{ day in when }}{%endraw%}">
						<li class="day">{% raw %}{{day.day}}{% endraw %} {{"at" | i18n}} {% raw %} {{day.time}}{% endraw %}</li>
					</template>
				</div>
			</template>
		</div>
		
		<div class="row control">
			<span class="spacer"></span>
			<button type="button" class="red" onclick="cancelForm()">{{"Cancel"|i18n}}</button>
			<button type="button" class="green" onclick="saveForm()">{{"Save"|i18n}}</button>
			<button id="submitBtn" class="hidden"></button>
		</div>
	</form>

</template>

<zdk-modal id="dialog-agenda" closebutton="false">
	<div class="modalContainer" fit>
		<div class="modalButtonContainer top">
			<button id="btn-cal-add" class="green" onclick="calAdd()">{{"Add"|i18n}}</button>
		</div>
		<div class="modalContentContainer" fit>
			<zdk-agenda id="agenda" lang="en-gb" hourHeight="40" hourShow="8" view="week" deleteButtons="true"
			            fit></zdk-agenda>
		</div>
		<div class="modalButtonContainer bottom">
			<button id="btn-cal-cancel" class="red" onclick="closeAgenda()">{{"Cancel"|i18n}}</button>
			<button id="btn-cal-confirm" class="blue" onclick="calMonthSave()">{{"Save"|i18n}}</button>
		</div>
	</div>

</zdk-modal>

<core-ajax id="putService"
           method="PUT"
           url="/api/beneficiary/services?category=social"
           handleAs="json"></core-ajax>

<script src="/bower_components/momentjs/min/moment.min.js"></script>
<script src="/bower_components/momentjs/min/moment-with-locales.min.js"></script>

<script>
	document.addEventListener('polymer-ready', function() {
		agenda = document.getElementById('agenda');
		
		agenda.addEventListener('zdk-event-close', function(e) {
			console.log(e.detail.event);
			agenda.events.splice(e.detail.event.num, 1);
			
			console.log(agenda.events);
		});
		
		document.querySelector("#putService")
			.addEventListener("core-response", function(evt) {
				if(editedService._id) {
					// update
					for (var i = 0, l = tplServices.model.services.length; i < l; i++) {
						var item = tplServices.model.services[i];
						if (tplServices.model.services[i]._id === editedService._id) {
							tplServices.model.services[i] = JSON.parse(JSON.stringify(evt.detail.response));
							break;
						}
					}
				} else {
					// create
					tplServices.model.services.push( JSON.parse(JSON.stringify(evt.detail.response)) );
				}
			})
	});
	
	function showForm( serviceID) {
		var modal = document.querySelector("zdk-modal#form");
		var tpl = document.querySelector("#formTpl");
		modal.show();
		
		if( !serviceID ) {
			editedService = {
				category : 'SOCIAL',
				label    : '',
				detail   : '',
				startDate: '',
				endDate  : '',
				frequency: 'daily',
				repeat   : 1,
				duration: 60,
				time: "10:00",
				provider:'',
				ref:'',
				when:[]
			};
		} else {
			data.services.forEach(function (item) {
				if (item._id === serviceID) {
					editedService = JSON.parse(JSON.stringify(item));
				}
			});
		}
		
		tpl.model = {
			lang : "fr",
			jobs : jobs,
			providers : professionals,
			hours  : hours,
			durations: durations,
			refServices : refServices,
			service: editedService
		};
	}
	
	function frequencyChange(evt) {
		var tpl = document.querySelector("#formTpl");
		if( tpl.model.service.frequency === evt.target.value ) { return; }
		
		setFrequency(evt.target.value);
	}
	
	function setFrequency( _frequency ) {
		var tpl = document.querySelector("#formTpl");
		tpl.model.service.frequency = _frequency;
		
		switch (frequency) {
			case 'punctual':
				tpl.model.service.duration = "01:00";
				tpl.model.service.time = "10:00";
				break;
			case 'daily':
				tpl.model.service.time = "10:00";
				break;
			case 'weekly':
				tpl.model.service.duration = "01:00";
				break;
			case 'monthly':
				tpl.model.service.duration = "01:00";
				tpl.model.service.time = "10:00";
				break
		}
	}
	
	function cancelForm() {
		editedService = {};
		document.querySelector("zdk-modal#form").hide();
	}
	
	function saveForm() {
		var form = document.querySelector("#form-add-service");
		
		if (!form.checkValidity()) {
			invalid = true;
			btn = document.querySelector("#submitBtn");
			if (btn) {
				btn.click();
				return false;
			}
		}
		
		if( !editedService.startDate ) {
			document.querySelector("#startDate").classList.add('invalid-form');
			return false;
		} else {
			document.querySelector("#startDate").classList.remove('invalid-form');
		}
		if( document.querySelector("#endDate") ) {
			if (!editedService.endDate) {
				document.querySelector("#endDate").classList.add('invalid-form');
				return false;
			} else {
				document.querySelector("#endDate").classList.remove('invalid-form');
			}
		}
		
		var obj = form2js( form );
		console.log( obj, editedService );
		
		editedService.provider = obj.provider;
		editedService.duration = parseInt(obj.duration,10);
		editedService.time = obj.time;
		editedService.repeat = parseInt(obj.repeat,10) || 0;
		editedService.detail = obj.detail;
		delete editedService.sourceName;
		
		if(!editedService._id) {
			// create
			editedService.ref = obj.ref;
			if( editedService.frequency === "punctual" ) {
				editedService.endDate = editedService.startDate;
				editedService.repeat = 0;
			}
			// tplServices.model.services.push( JSON.parse(JSON.stringify(editedService)) );
			
		}
		
		var ajax = document.querySelector("#putService");
		ajax.body = JSON.stringify(editedService);
		ajax.go();
		
		document.querySelector("zdk-modal#form").hide();
	}
	
	function onBtnCalMonthClick() {
		agenda.view = 'month';
		
		agenda.today();
		agenda.next();
		document.getElementById('dialog-agenda').show();
		agenda.drawBG();
		
		// Load events
		var events = [];
		for (var i = 0, length = editedService.when.length; i < length; i++) {
			var time = moment(editedService.time, 'HH:mm');
			var day = moment(agenda.day).startOf('month');
			day.add(editedService.when[i] - 1, 'days');
			day.hour(time.hour());
			day.minute(time.minute());
			
			events.push({
				className: 'event1',
				label: '',
				start: day.toISOString(),
				end: moment(day).add(editedService.duration, 'minutes').toISOString()
			});
		}
		
		agenda.events = events;
	}
	
	function onBtnCalWeekClick() {
		agenda.view = 'week';
		
		agenda.today();
		agenda.next();
		document.getElementById('dialog-agenda').show();
		agenda.drawBG();
		agenda.setTime();
		agenda.drawEvents();
		
		// Load events
		var events = [];
		for (var i = 0, length = editedService.when.length; i < length; i++) {
			var time = moment(editedService.time, 'HH:mm');
			var day = moment(agenda.day).startOf('week');
			day.add(editedService.when[i] - 1, 'days');
			day.hour(time.hour());
			day.minute(time.minute());
			
			events.push({
				className: 'event2',
				label: '',
				start: day.toISOString(),
				end: moment(day).add(editedService.duration, 'minutes').toISOString()
			});
		}
		
		agenda.events = events;
	}
	
	function calAdd() {
		if (!agenda) { return; }
		
		var time, day;
		switch (agenda.view) {
			case 'month':
				time = moment(editedService.time, 'HH:mm');
				day = moment(agenda.day).startOf('month');
				day.hour(time.hour());
				day.minute(time.minute());
				var month = day.month();
				
				while (hasEvent(day.format('YYYY-MM-DD')) && day.month() === month) {
					day.add(1, 'day');
				}
				
				if (day.month() === month) {
					// Add an event
					agenda.events.push({
						className: 'event1',
						label: '',
						start: day.toISOString(),
						end: moment(day).add(editedService.duration.value, 'minutes').toISOString()
					});
				}
				break;
			
			case 'week':
				time = moment(agenda.hourShow, 'HH:mm');
				day =  moment(agenda.day).startOf('week');
				day.hour(time.hour());
				day.minute(time.minute());
				var week = day.week();
				
				while (hasEvent(day.format('YYYY-MM-DD')) && day.week() === week) {
					day.add(1, 'day');
				}
				
				if (day.week() === week) {
					// Add an event
					agenda.events.push({
						className: 'event1',
						label: '',
						start: day.toISOString(),
						end: moment(day).add(editedService.duration, 'minutes').toISOString()
					});
				}
				break;
		}
	}
	
	function hasEvent(day) {
		for (var i = 0, length = agenda.events.length; i < length; i++) {
			if (moment(agenda.events[i].start, moment.ISO_8601).format('YYYY-MM-DD') === day) {
				return true;
			}
		}
		return false;
	}
	
	function calMonthSave() {
		var day, i, length, stringDays;
		
		var days = [];
		day = moment(agenda.day).startOf('month');
		var month = day.month();
		
		while (day.month() === month) {
			if (hasEvent(day.format('YYYY-MM-DD'))) {
				days.push(day.date());
			}
			day.add(1, 'day');
		}
		
		editedService.when = days;
		document.getElementById('dialog-agenda').hide();
	}
	
	function closeAgenda() {
		// Hide the agenda dialog
		document.getElementById('dialog-agenda').hide();
		
		if (agenda) {
			agenda.events = [];
		}
	}
</script>