{% extends './page.htm' %}

{% block title %}{{ "Create a questionnaire"|i18n }}{% endblock %}

{% block head %}
{% parent %}
<script src="/bower_components/mustache/mustache.js"></script>
<script src="/bower_components/rsvp/rsvp.min.js"></script>
<script src="/bower_components/form2js/src/form2js.js"></script>
{% endblock %}

{% block content %}
<script type="text/template" id="tplHeaderQuestion">
	<span class="debug">{%raw%}{{name}}.header.{{lang}}{%endraw%}</span>
    <div class="row">
		<label class="bold">Question header: </label>
		<input type="text" name="{%raw%}{{name}}.header.{{lang}}{%endraw%}" />
	</div>
	<div class="row">
		<label class="bold">Subscore: </label>
		<input type="text" name="{%raw%}{{name}}.subscore{%endraw%}" />
	</div>
	<div class="row control btnContainer">
		<span class="spacer"></span>
		<button type="button" class="small red deleteHeaderQuestion">delete header question</button>
	</div>
	<hr>
	<div class="row control btnContainer">
		<span class="spacer"></span>
		<button type="button" class="small blue addHeaderQuestion" data-obj="{%raw%}{{name}}.questions;{{lang}}{%endraw%}">add header question</button>
		<button type="button" class="small blue addQuestion" data-obj="{%raw%}{{name}}.questions;{{lang}}{%endraw%}">add question</button>
	</div>
</script>

<script type="text/template" id="tplQuestion">
	<div class="row">
		<span class="debug">{%raw%}{{name}}.text.{{lang}}{%endraw%}</span>
		<div class="col">
			<label class="bold">Question: </label>
			<input type="text" name="{%raw%}{{name}}.text.{{lang}}{%endraw%}" />
		</div>
		<div class="col btnContainer">
			<button type="button" class="small red deleteQuestion">delete question</button>
		</div>
	</div>
	<br/>
	<div class="row control btnContainer">
		<span class="spacer"></span>
		<button type="button" class="small blue addChoice" data-obj="{%raw%}{{name}}.choice;{{lang}}{%endraw%}">add choice</button>
	</div>
	<br/>
</script>

<script type="text/template" id="tplChoice">
	<span class="debug">{%raw%}{{name}}.text.{{lang}}{%endraw%}</span>
	<div class="col">
		<label>Choice Text</label>
		<input type="text" name="{%raw%}{{name}}.text.{{lang}}{%endraw%}" />
	</div>
	<div class="col">
		<label>Choice Value</label>
		<input type="text" name="{%raw%}{{name}}.value{%endraw%}" />
	</div>
	<div class="col">
		<label>Choice System</label>
		<select name="{%raw%}{{name}}.system{%endraw%}">
    		<option value="integer">integer</option>
    		<option value="boolean">boolean</option>
    		<option value="decimal">decimal</option>
    		<option value="string">string</option>
    	</select>
	</div>
	<div class="col btnContainer">
		<button type="button" class="small red deleteChoice">delete</button>
	</div>
</script>

<script type="text/javascript">

	var promiseXHR = function(method, url, statusOK, data) {
	    var promise = new RSVP.Promise(function(resolve, reject) {
	        var client = new XMLHttpRequest();
	        statusOK = statusOK ? statusOK : 200;
	        client.open(method, url);
	        client.onreadystatechange = function handler() {
	            if (this.readyState === this.DONE) {
	                if (this.status === statusOK) {
	                    resolve(this.response);
	                } else {
	                    reject(this);
	                }
	            }
	        };
	        client.send(data ? data : null);
	    });

	    return promise;
	};

	function _deleteHeaderQuestion(node){
		console.log("_deleteHeaderQuestion");
		while (!node.classList.contains("nestedQuestionnaire") && !node.classList.contains("itemContainer")){
    		node = node.parentNode;
    	}
    	node.parentNode.removeChild(node);
	}

	function _deleteQuestion(node){
		console.log("_deleteQuestion");
		while (!node.classList.contains("nestedQuestionnaire") && !node.classList.contains("itemContainer")){
    		node = node.parentNode;
    	}
    	node.parentNode.removeChild(node);
	}

	function _deleteChoice(node){
		console.log("_deleteChoice");
		while (!node.classList.contains("answers")){
    		node = node.parentNode;
    	}
    	node.parentNode.removeChild(node);
	}

	function _addHeaderQuestion(node){
		console.log("_addHeaderQuestion", node.getAttribute("data-obj"));
		var obj, elt, modelData, html, div, cl;

		obj = node.getAttribute("data-obj").split(";");
		elt = document.querySelector("#tplHeaderQuestion").innerHTML;
	    modelData = { name: obj[0]+"["+(""+Math.random()).split(".")[1]+"]", lang: obj[1]};
	    html = Mustache.render(elt, modelData);
	    div = document.createElement("div");
	    div.innerHTML = html;

	    while (!node.classList.contains("btnContainer")){
    		node = node.parentNode;
    	}
    	cl = node.parentNode.classList;
    	div.className = cl.contains("itemContainer") || cl.contains("nestedQuestionnaire") ? "nestedQuestionnaire" : "itemContainer";
    	node.parentNode.insertBefore(div, node);
	}

	function _addQuestion(node){
		console.log("_addQuestion", node.getAttribute("data-obj"));

		var obj, elt, modelData, html, div, cl;

		obj = node.getAttribute("data-obj").split(";");
		elt = document.querySelector("#tplQuestion").innerHTML;
	    modelData = { name: obj[0]+"["+(""+Math.random()).split(".")[1]+"]", lang: obj[1]};
	    html = Mustache.render(elt, modelData);
	    div = document.createElement("div");
	    div.innerHTML = html;

	    while (!node.classList.contains("btnContainer")){
    		node = node.parentNode;
    	}
    	cl = node.parentNode.classList;
    	div.className = cl.contains("itemContainer") || cl.contains("nestedQuestionnaire") ? "nestedQuestionnaire" : "itemContainer";
    	node.parentNode.insertBefore(div, node);
	}

	function _addChoice(node){
		console.log("_addChoice", node.getAttribute("data-obj"));
		var obj, elt, modelData, html, div;

		obj = node.getAttribute("data-obj").split(";");
		elt = document.querySelector("#tplChoice").innerHTML;
	    modelData = { name: obj[0]+"["+(""+Math.random()).split(".")[1]+"]", lang: obj[1]};
	    html = Mustache.render(elt, modelData);
	    div = document.createElement("div");
	    div.className = "row answers";
	    div.innerHTML = html;

	    while (!node.classList.contains("btnContainer")){
    		node = node.parentNode;
    	}
    	node.parentNode.insertBefore(div, node);
	}

	function saveForm(){
		console.log("saveForm");
		var obj = form2js(document.forms.newQ);
		console.log("res", obj);

		if(obj._id){
			//Update
			promiseXHR("PUT", "/api/questionnaires/" + obj._id, 200, JSON.stringify(obj)).then(function(response) {
	            alert("SUCCESS");
	        }, function(error) {
	            alert("FAILED");
	            console.log("saveForm - error: ", error);
	        });
		}
		else{
			//Creation
			promiseXHR("POST", "/api/questionnaires", 200, JSON.stringify(obj)).then(function(response) {
	            alert("SUCCESS");
	        }, function(error) {
	            alert("FAILED");
	            console.log("saveForm - error: ", error);
	        });
		}
	};

function init() {
	console.log("init");

    //Event click management
    document.forms.newQ.addEventListener("click", function(evt){
    	var node = evt.target,
    		cl = node.classList;

    	if(node.tagName.toLowerCase() !== "button"){
    		return;
    	}

    	if(cl.contains("deleteHeaderQuestion")){
    		_deleteHeaderQuestion(node);
    	}
    	else if(cl.contains("addHeaderQuestion")){
    		_addHeaderQuestion(node);
    	}
    	else if(cl.contains("addQuestion")){
    		_addQuestion(node);
    	}
		else if(cl.contains("deleteQuestion")){
    		_deleteQuestion(node);
    	}
    	else if(cl.contains("deleteChoice")){
    		_deleteChoice(node);
    	}
    	else if(cl.contains("addChoice")){
    		_addChoice(node);
    	}

    }, true);
}

window.addEventListener("DOMContentLoaded", init, false);
</script>
<style>
	.answers{
		margin-left: 30px;
	}
	.space{
		width: 20%;
		margin: 30px auto;
		border-color: black;
	}
	.nestedQuestionnaire{
		margin-left: 20px;
	}
	div.col.btnContainer{
		flex: 0.15;
		-ms-flex: 0.15;
		-moz-flex: 0.15;
		-webkit-flex: 0.15;
	}
	form{
		position: relative;
	}
	.debug{
		background: yellow;
		margin-right: 10px;
		font-size: 10px;
		position: absolute;
	}
	.nestedQuestionnaire{
		background: grey;
	}
	.itemContainer{
		background: silver;
	}
</style>

{% macro tpl(q, idx) %}
	{% set name = "questions" %}
	{% for key, val in idx %}
		{% set name += "["+val+"]" %}
		{% if !loop.last %}
			{% set name += ".questions" %}
		{% endif %}
	{% endfor %}

	{% if q.header %}
		<span class="debug">{{name}}.header.{{lang}}</span>
		<div class="row">
			<label class="bold">Question header: </label>
			<input type="text" name="{{name}}.header.{{lang}}" value="{{q.header[lang]}}" />
		</div>
		<div class="row">
			<label class="bold">Subscore: </label>
			<input type="text" name="{{name}}.subscore" value="{{q.subscore}}" />
		</div>
		<div class="row control btnContainer">
			<span class="spacer"></span>
			<button type="button" class="small red deleteHeaderQuestion">delete header question</button>
		</div>
		<hr>
		{% for subQ in q.questions %}
			{% set idx = idx|push(loop.index) %}
			<div class="nestedQuestionnaire">
				{{tpl(subQ, idx)}}
			</div>
			{% set idx = idx|pop() %}

			{% if loop.last %}
				<div class="row control btnContainer">
					<span class="spacer"></span>
					<button type="button" class="small blue addHeaderQuestion" data-obj="{{name}}.questions;{{lang}}">add header question</button>
					<button type="button" class="small blue addQuestion" data-obj="{{name}}.questions;{{lang}}">add question</button>
				</div>
			{% endif %}
		{% endfor %}
	{% else %}
		<div class="row">
			<span class="debug">{{name}}.text.{{lang}}</span>
			<div class="col">
				<label class="bold">Question: </label>
				<input type="text" name="{{name}}.text.{{lang}}" value="{{q.text[lang]}}" />
			</div>
			<div class="col btnContainer">
				<button type="button" class="small red deleteQuestion">delete question</button>
			</div>
		</div>
		<br/>
	{% endif %}
	{% for c in q.choice %}
		<div class="row answers">
		<span class="debug">{{name}}.choice[{{loop.index}}].text.{{lang}}</span>
			<div class="col">
				<label>Choice Text</label>
				<input type="text" name="{{name}}.choice[{{loop.index}}].text.{{lang}}" value="{{c.text[lang]}}" />
			</div>
			<div class="col">
				<label>Choice Value</label>
				<input type="text" name="{{name}}.choice[{{loop.index}}].value" value="{{c.value}}" />
			</div>
			<div class="col">
				<label>Choice System</label>
				<select name="{{name}}.choice[{{loop.index}}].system">
		    		<option value="integer" {% if c.system === "integer" %}selected{% endif %}>integer</option>
		    		<option value="boolean" {% if c.system === "boolean" %}selected{% endif %}>boolean</option>
		    		<option value="decimal" {% if c.system === "decimal" %}selected{% endif %}>decimal</option>
		    		<option value="string" {% if c.system === "string" %}selected{% endif %}>string</option>
		    	</select>
			</div>
			<div class="col btnContainer">
				<button type="button" class="small red deleteChoice">delete</button>
			</div>
		</div>
		{% if loop.last %}
			<div class="row control btnContainer">
				<span class="spacer"></span>
				<button type="button" class="small blue addChoice" data-obj="{{name}}.choice;{{lang}}">add choice</button>
			</div>
			<br/>
		{% endif %}
	{% endfor %}
{% endmacro %}

<div class="mainContainer">
	<form name="newQ" autocomplete="off" onsubmit="saveForm(); return false;">
		<input type="hidden" name="_id" value="{{questionnaire._id.toString()}}"/>
		<div class="row">
			<div class="col">
				<label>Questionnaire name</label>
				<input type="text" name="name" value="{{questionnaire.name}}"/>
			</div>
			<div class="col">
				<label>Questionnaire text</label>
				<input type="text" name="text.{{lang}}" {% if questionnaire.text[lang] %}value="{{questionnaire.text[lang]}}"{% endif %}/>
			</div>
		</div>
		<hr>
		{% for q in questionnaire.questions %}
			<div class="itemContainer">
				{% set number = "" %}
				{{tpl(q, [loop.index])}}
			</div>
			{% if !loop.last %}
				<hr class="space">
			{% endif %}
		{% endfor %}
		<div class="row control btnContainer">
			<span class="spacer"></span>
			<button id="addHeader" type="button" class="blue addHeaderQuestion" data-obj="questions;{{lang}}">New Header Question</button>
			<button id="addSimple" type="button" class="blue addQuestion" data-obj="questions;{{lang}}">New Simple Question</button>
		</div>
		<div class="row control">
			<span class="spacer"></span>
			<button type="button" class="red" onclick="window.history.back()">Cancel</button>
			<button class="blue">Save</button>
		</div>
	</form>
</div>
{% endblock %}