{% extends './page.htm' %}
{% block title %}Data Recording{% endblock %}
{% block head %}
{% parent %}
<script src="/bower_components/mustache/mustache.js"></script>
<script src="/bower_components/rsvp/rsvp.min.js"></script>
<script src="/bower_components/momentjs/min/moment-with-locales.min.js"></script>
<script src="/bower_components/zdk-calendar/form2js.js"></script>
<script src="/scripts/questionnaireButton.js"></script>
<script src="/scripts/utils.js"></script>
<script src="/tpl/dataRecordEdit.js"></script>
<style>
	select {
		min-width:100px;
	}
	input[type=text] {
		width: 100%;
	}
	h2 {
		margin: 0;
		font-size: 1.2em;
	}

	#questionnaireIframe {
		display: none;
	}

	#questionnaireIframe.visible {
		display: block;
		position: absolute;
		left: 0;
		right: 0;
		top: 0;
		bottom: 0;
		margin: 0;
	}
</style>
{% endblock %}

{% block content %}

{#
	Macro for :
	-select threshold
	-value threshold
	-line repeating (for existing items)
	-line adding (for new items)
#}

<div class="hidden" id="lang">{{lang}}</div>

<script type="html/text" id="selectParam">
	{% if view === 'create'%}
	<select onchange="updateParam(this)" name="items[{% raw %}{{ idx }}{% endraw %}].text">
	{% else%}
	<select onchange="updateParam(this)" name="items[{% raw %}{{id}}{% endraw %}].text">
	{% endif%}
		<option></option>
	{% raw %}
		{{#lists}}
			<option value="{{ref}}" {% endraw %}{% if view !== 'create'%}{% raw %}{{#selection}}{{ref}}{{/selection}}{% endraw %}{% endif%}{% raw %} id="option-{{ref}}">{{labelLang}}</option>
		{{/lists}}
	{% endraw %}

	</select>
</script>

<div id="content">
	{% macro line(cat) %}
	<div id="ID{{item._id.toString()}}" class="line">
		<div class="type hidden">{{ item.text }}</div>
		<div class="category hidden">{{cat}}</div>
		<div class="readMode">
			<div class="row">
				{% raw %}{{#item}}{% endraw %}
				<div class="col bold" style="flex:2">{% raw %}{{ labelLang }}{% endraw %}</div>
				<div class="col item-value" style="max-width:150px">{{ item.value }}</div>
				{% if cat !== 'questionnaire' %}
				<div class="col" style="max-width:150px">{% raw %}{{ unityLabel }}{% endraw %}</div>
				{% else %}
				<div class="col" style="max-width:150px">
				<button type="button" class="blue small answer" data-answer="{{item.ref}}" onclick="showAnswer('{{item.ref}}')">{{"Questionnaire"|i18n}}</button>
				</div>
				{% endif %}
				
				{% if cat !== 'questionnaire' %}
				{% raw %}
				<div class="col" style="max-width:150px">
					<div class="min-treshold spacing-around">{{#threshold}}{{min}}{{/threshold}}</div>
				</div>
				<div class="col" style="max-width:150px">
					<div class="max-treshold spacing-around">{{#threshold}}{{max}}{{/threshold}}</div>
				</div>
				{% endraw %}
				{% else %}
				<div class="col" style="max-width:150px"></div>
				<div class="col" style="max-width:150px"></div>
				{% endif %}
				
				{% raw %}{{/item}}{% endraw %}

				{% if admin %}
				<div style="width:100px; text-align:right">
					{% if cat !== 'questionnaire' %}
					<div>
						<button type="button" class="blue small" onclick="toggleEditMode('{{item._id.toString()}}')">Edit</button>
					</div>
					{% endif %}
					<div>
						<button type="button" class="red small" onclick="confirmDeleteItem('{{item._id.toString()}}')">Delete</button>
					</div>
				</div>
				{% else %}
				<div style="width:70px"></div>
				{% endif %}

			</div>
		</div>
		<div class="updateMode hidden">
			<div class="row">
				{% raw %}
				{{#item}}
				<div class="col item-text" style="flex:2"></div>
				<div class="col item-value" style="max-width:150px">
				   {% endraw %}<input type="text" value="{{ item.value }}" name="items[{{item._id.toString()}}].value"/></div>{% raw %}
				<div class="col unity" style="max-width:150px">{{ unityLabel }}</div>

				{% endraw %}{% if cat !== 'questionnaire' %}{% raw %}
				<div class="col" style="max-width:150px">
					<div class="min-treshold spacing-around">{{#threshold}}{{min}}{{/threshold}}</div>
				</div>
				<div class="col" style="max-width:150px">
					<div class="max-treshold spacing-around">{{#threshold}}{{max}}{{/threshold}}</div>
				</div>
				{% endraw %}{% endif %}{% raw %}

				{{/item}}
				{% endraw %}

				<input name="items[{{item._id.toString()}}].category" class="item-category" type="hidden" value="{{item.category}}">
				<input name="items[{{item._id.toString()}}]._id" type="hidden" value="{{item._id.toString()}}">
				<input name="items[{{item._id.toString()}}].automatic" type="hidden" value="{{item.automatic}}">
				<input name="items[{{item._id.toString()}}].dataRecordID" type="hidden" value="{{item.dataRecordID.toString()}}">
		
				<div style="width:100px; text-align:right">
					<div>
						<button type="button" class="blue small" onclick="toggleEditMode('{{item._id.toString()}}')">Back</button>
					</div>
					<div>
						<button type="button" class="red small" onclick="confirmDeleteItem('{{item._id.toString()}}')">Delete</button>
					</div>
				</div>
			</div>

		</div>
	</div>
	{% endmacro %}


	{% macro addItem(category) %}
	<div id="add{{category}}">
		<div class="category hidden">{{category}}</div>
		<div id="newItems-{{category}}">

		</div>
		<div class="row control">
			<span class="spacer"></span>
			<button type="button" class="green small" onclick="addLine('{{category}}')">Add Item</button>
		</div>
	</div>
	{% endmacro %}


	<script type="template" id="newItem">
		<div class="col item-text" style="flex:2"></div>

		{% raw %}{{#questionnaire}}{% endraw %}
		<div class="col" style="max-width:150px">
			<input type="text" class="questionnaire-score" name="items[{% raw %}{{idx}}{% endraw %}].value" value="" disabled />
			<input type="hidden" class="questionnaire-score" name="items[{% raw %}{{idx}}{% endraw %}].value" value="" />
		</div>
		<input type="hidden" class="questionnaire-answer" name="items[{% raw %}{{idx}}{% endraw %}].ref" value="" />
		<div class="col questionnaire-button-container" style="max-width:150px">
			<span></span>
			<a class="button small blue disabled" href="">Questionnaire</a>
		</div>
		<div class="col" style="max-width:150px"></div>
		<div class="col" style="max-width:150px"></div>
		{% raw %}{{/questionnaire}}{% endraw %}
		
		{% raw %}{{^questionnaire}}{% endraw %}
		<div class="col" style="max-width:150px"><input type="text" name="items[{% raw %}{{idx}}{% endraw %}].value"/></div>
		<div class="col" style="max-width:150px"><span class="unity"></span></div>
		<div class="col" style="max-width:150px">
			<div class="min-treshold spacing-around"></div>
		</div>
		<div class="col" style="max-width:150px">
			<div class="max-treshold spacing-around"></div>
		</div>
		{% raw %}{{/questionnaire}}{% endraw %}

		<input name="items[{% raw %}{{idx}}{% endraw %}].category" id="new-item-category" type="hidden">
		<div style="width:100px; text-align:right">
			<button type="button" class="blue small" onclick="removeLine(this)">Annuler</button>
		</div>
	</script>


	{#
		The Page
		-create and update actions
	#}

	<div class="row title">
		<label class="title">
			<span id="datetime">
				{{dataRecordItems.datetime}}
			</span>
			{% if dataRecordItems.home %}
				{{ "From Home"|i18n }}
			{% else %}
				{{ "From Consultation"|i18n }} {{dataRecordItems.source.name.family}} {{dataRecordItems.source.name.given}}
			{% endif %}
		</label>
	</div>

	<form name="dataRecord" id="dataRecord">
		<zdk-panel heading="{{'Physiological parameters' |i18n}}" collapsable="false" collapsed="false">
			<div class="row">
				<div class="col bold" style="flex:2">{{ 'Parameter'|i18n }}</div>
				<div class="col bold" style="max-width:150px">{{ 'Value'|i18n }}</div>
				<div class="col bold" style="max-width:150px">{{ 'Unity'|i18n }}</div>
				<div class="col bold" style="max-width:150px">{{ 'Min threshold' | i18n }}</div>
				<div class="col bold" style="max-width:150px">{{ 'Max threshold' | i18n }}</div>
				<div style="width:70px; text-align:right"></div>
			</div>
			{% if view === 'create'%}
				{{ addItem('General') }}
			{% else %}
				<h2 class="bold">Général</h1>
				{% for item in dataRecordItems.items.items %}
					{% if item.category === 'General' %}
						{{ line('General') }}
					{% endif %}
				{% endfor %}
				<h2 class="bold">HDIM</h1>
				{% for item in dataRecordItems.items.items %}
					{% if item.category === 'HDIM' %}
						{{ line('HDIM') }}
					{% endif %}
				{% endfor %}
			{% endif %}

		</zdk-panel>
		<zdk-panel heading="{{'Symptoms assessments' |i18n}}" collapsable="false" collapsed="false">
			<div class="row">
				<div class="col bold" style="flex:2">{{ 'Assessment'|i18n }}</div>
				<div class="col bold" style="max-width:150px">{{ 'Value'|i18n }}</div>
				<div class="col bold" style="max-width:150px"></div>
				<div class="col bold" style="max-width:150px"></div>
				<div class="col bold" style="max-width:150px"></div>
				<div style="width:70px; text-align:right"></div>
			</div>
			{% if view === 'create'%}
				{{ addItem('symptom') }}
			{% else %}
				{% for item in dataRecordItems.items.items %}
					{% if item.category === 'symptom' %}
						{{ line('symptom') }}
					{% endif %}
				{% endfor %}
			{% endif %}

		</zdk-panel>
		<zdk-panel heading="{{'Questionnaires' |i18n}}" collapsable="false" collapsed="false">
			<div class="row">
				<div class="col bold" style="flex:2">{{ 'Questionnaire'|i18n }}</div>
				<div class="col bold" style="max-width:150px">{{ 'Value'|i18n }}</div>
				<div class="col bold" style="max-width:150px"></div>
				<div class="col bold" style="max-width:150px"></div>
				<div class="col bold" style="max-width:150px"></div>
				<div style="width:70px; text-align:right"></div>
			</div>
			{% if view === 'create'%}
				{{ addItem('questionnaire') }}
			{% else %}
				{% for item in dataRecordItems.items.items %}
					{% if item.category === 'questionnaire' %}
						{{ line('questionnaire') }}
					{% endif %}
				{% endfor %}
			{% endif %}

		</zdk-panel>
	</form>

	<div class="row control" style="height:60px; align-content: center">
		<span class="spacer"></span>
		{% if view === 'create'%}
		<button class="green" onclick="create()">save</button>
		{% else %}
		<a href="/datarecord"><button class="blue big">back</button></a>
		<button class="green" onclick="update('{{dataRecordItems._id.toString()}}')">save</button>
		{% endif %}
	</div>
</div>


{#
	Hidden Elements only for js use in frontend
#}

<zdk-modal id="statusModal" closebutton="false">
	<div class="modalContainer">
		<div class="modalTitleContainer"></div>
		<div class="modalContentContainer"></div>
		<div class="modalButtonContainer"></div>
	</div>
</zdk-modal>

<div class="hidden">
	<div id="trad_save">{{ "Save"|i18n }}</div>
	<div id="trad_create">{{ "Create"|i18n }}</div>
	<div id="trad_delete">{{ "Delete"|i18n }}</div>
	<div id="trad_error">{{ "Error"|i18n }}</div>
	<div id="trad_update">{{ "Update"|i18n }}</div>
	<div id="trad_confirm_save">{{ "Are you sure you want to save those changes ?"|i18n }}</div>
	<div id="trad_confirm_delete">{{ "Are you sure you want to delete this item ?"|i18n }}</div>
	<div id="trad_error_occured">{{ "An error occured"|i18n }}</div>
	<div id="trad_success_create">{{ "Item successfully created"|i18n }}</div>
	<div id="trad_success_update">{{ "Item successfully updated"|i18n }}</div>
	<div id="trad_yes">{{ "Yes"|i18n }}</div>
	<div id="trad_no">{{ "No"|i18n }}</div>
	<div id="trad_ok">{{ "Ok"|i18n }}</div>
</div>

{% endblock %}



