{% extends './page.htm' %}

{% block title %}{{"Questionnaire overview" | i18n}}{% endblock %}

{% block head %}
{% parent %}
<script src="/bower_components/rsvp/rsvp.min.js"></script>
<script src="/bower_components/form2js/src/form2js.js"></script>
<script src="/tpl/questionnaireOverview.js"></script>
{% endblock %}
{% block content %}

<style>
	div.row label {
		width: 350px;
	}
	.answers {
		margin-left: 30px;
	}
	.space {
		/* width: 20%; */
		margin: 30px auto;
		border-color: black;
	}
	.nestedQuestionnaire {
		margin-left: 20px;
	}
	.preview {
		font-size: 1.2em;
		color: Tomato;
		border: 2px solid tomato;
		text-align: center;
		line-height: 50px;
	}
	span.warn {
		color:Tomato;
	}
</style>

{% macro tpl(q, idx) %}
	{% set name = "questions" %}
	{% for key, val in idx %}
		{% set name += "["+val+"]" %}
		{% if !loop.last %}
			{% set name += ".questions" %}
		{% endif %}
	{% endfor %}

	{% if q.headerRef %}
		<div class="bold">{{idx|join("-")}} - {{q.headerLabel[lang] || q.headerLabel["en"] }} {% if !q.headerLabel[lang] %}<span class="warn">( en )</span>{% endif %}</div>
		<input type="hidden" name="{{name}}.subscore" value="{{q.subscore}}" />
		<hr>
		{% for subQ in q.questions %}
			{% set idx = idx|push(loop.index) %}
			<div class="nestedQuestionnaire">
				{{tpl(subQ, idx)}}
			</div>
			{% set idx = idx|pop() %}
		{% endfor %}
	{% else %}
		<div class="row">
			<div>{{idx|join("-")}} - {{q.label[lang] || q.label["en"] }} {% if !q.label[lang] %}<span class="warn">( en )</span>{% endif %}</div>
		</div>
		<br/>
	{% endif %}
	{% for c in q.choice %}
		<div class="row answers">
			{% if !c.label[lang] && !c.label["en"] %}
				<input type="number" name="{{name}}.choice" required />
			{% else %}
				<label for="{{name}}.choice">{{c.label[lang] || c.label["en"] }} {% if !c.label[lang] %}<span class="warn">( en )</span>{% endif %}</label>
				<input type="radio" name="{{name}}.choice" value="{{c.value}}" required />
			{% endif %}
		</div>
		{% if loop.last %}
			<br/>
		{% endif %}
	{% endfor %}
{% endmacro %}

<div class="mainContainer">
	{% if preview %}
	<div class="preview">{{'Preview display'|i18n}}</div>
	{% endif %}
	<h2>{{questionnaire.label[lang] || questionnaire.label["en"] }} {% if !questionnaire.label[lang] %}<span class="warn">( en )</span>{% endif %}</h2>
	<form autocomplete="off" name="questionnaire" onsubmit="checkForm(); return false;">
		<input type="hidden" name="ref" value="{{questionnaire._id.toString()}}" />
		<input type="hidden" name="score" value="{{questionnaire.score}}" />
		{% for q in questionnaire.questions %}
			<div class="itemContainer">
				{% set number = "" %}
				{{tpl(q, [loop.index])}}
			</div>
			{% if !loop.last %}
				<hr class="space">
			{% endif %}
		{% endfor%}
		{% if preview %}
		<div class="row control">
			<span class="spacer"></span>
			<button type="button" class="blue" onclick="window.history.back()">{{'Back' | i18n}}</button>
		</div>
		{% else %}
		<div class="row control">
			<span class="spacer"></span>
			<button type="button" class="red" onclick="window.parent.closeQuestionnaire()">{{'Cancel'|i18n}}</button>
			<button class="green">{{'OK' | i18n}}</button>
		</div>
		{% endif %}
	</form>

	<zdk-modal id="statusModal" closebutton="false">
		<div class="modalContainer">
			<div class="modalTitleContainer">{{'Result' | i18n}}</div>
			<div class="modalContentContainer">{{'Your score is: ' |i18n}}<span id="score">{{score}}</span></div>
			<div class="modalButtonContainer">
				<button class="green" onclick="closeModal();">{{'OK' | i18n}}</button>
			</div>
		</div>
	</zdk-modal>
</div>

<div id="questionnaireName" class="hidden">{{questionnaire.name}}</div>
{% endblock %}
